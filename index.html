<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‚¡ç¥¨æ¶¨è·Œå¹…åˆ†æå·¥å…·ï¼ˆå…¨ GitHub éƒ¨ç½²ï¼‰</title>
    <!-- å¤–éƒ¨ä¾èµ– -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <style>
        .chart-container { height: 400px; margin: 20px 0; position: relative; }
        .loading { display: none; text-align: center; padding: 50px; }
        .chart-loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 10; }
        .result-section { display: none; margin-top: 30px; }
        .error-alert { display: none; margin-top: 15px; padding: 15px; background: #fef2f2; color: #dc2626; border-radius: 8px; }
        .search-results { position: absolute; z-index: 50; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .search-result-item { padding: 0.75rem; cursor: pointer; }
        .search-result-item:hover { background-color: #f3f4f6; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 max-w-6xl mx-auto p-4 md:p-8">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">ğŸ“Š è‚¡ç¥¨æ¶¨è·Œå¹…åˆ†æå·¥å…·ï¼ˆå…¨ GitHub éƒ¨ç½²ï¼‰</h1>

    <!-- é”™è¯¯æç¤º -->
    <div class="error-alert" id="errorAlert"></div>

    <!-- å‚æ•°è¾“å…¥è¡¨å• -->
    <div class="bg-white rounded-xl shadow-md p-6 md:p-8 mb-8 relative">
        <h2 class="text-xl font-semibold mb-6">è¾“å…¥åˆ†æå‚æ•°</h2>
        <form id="analysisForm" class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- è‚¡ç¥¨ä»£ç ï¼ˆå¸¦æœç´¢åŠŸèƒ½ï¼‰ -->
            <div class="relative">
                <label for="ticker" class="block text-sm font-medium text-gray-700 mb-1">è‚¡ç¥¨ä»£ç /åç§°ï¼ˆæ”¯æŒæœç´¢ï¼‰</label>
                <input 
                    type="text" 
                    id="ticker" 
                    name="ticker" 
                    placeholder="å¦‚ AAPLã€æ‹›å•†é“¶è¡Œã€600036.SS" 
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                <!-- æœç´¢ç»“æœä¸‹æ‹‰æ¡† -->
                <div class="search-results" id="searchResults"></div>
            </div>

            <!-- ç›®æ ‡æ¶¨è·Œå¹… -->
            <div>
                <label for="targetChange" class="block text-sm font-medium text-gray-700 mb-1">ç›®æ ‡æ¶¨è·Œå¹…(%)</label>
                <input 
                    type="number" 
                    id="targetChange" 
                    name="targetChange" 
                    step="0.1" 
                    placeholder="å¦‚ 5ï¼ˆä¸Šæ¶¨5%ï¼‰ã€-3ï¼ˆä¸‹è·Œ3%ï¼‰" 
                    required
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
            </div>

            <!-- æ•°æ®å‘¨æœŸï¼ˆæ›´å¤šé€‰é¡¹ï¼‰ -->
            <div>
                <label for="period" class="block text-sm font-medium text-gray-700 mb-1">æ•°æ®å‘¨æœŸ</label>
                <select 
                    id="period" 
                    name="period" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                    <option value="max">å…¨éƒ¨å†å²</option>
                    <option value="10y">è¿‘10å¹´</option>
                    <option value="5y">è¿‘5å¹´</option>
                    <option value="2y">è¿‘2å¹´</option>
                    <option value="1y">è¿‘1å¹´</option>
                    <option value="ytd">ä»Šå¹´è‡³ä»Š</option>
                    <option value="6mo">è¿‘6ä¸ªæœˆ</option>
                    <option value="3mo">è¿‘3ä¸ªæœˆ</option>
                    <option value="1mo">è¿‘1ä¸ªæœˆ</option>
                    <option value="14d">è¿‘2å‘¨</option>
                    <option value="7d">è¿‘1å‘¨</option>
                    <option value="5d">è¿‘5å¤©</option>
                    <option value="1d">è¿‘1å¤©</option>
                </select>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <div class="md:col-span-3">
                <button 
                    type="submit" 
                    class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors duration-300"
                >
                    å¼€å§‹åˆ†æ
                </button>
            </div>
        </form>
    </div>

    <!-- åŠ è½½ä¸­æç¤º -->
    <div class="loading" id="loading">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto mb-4"></div>
        <p>æ­£åœ¨åˆ†ææ•°æ®ï¼Œè¯·ç¨å€™ï¼ˆé¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦10ç§’ï¼‰...</p>
    </div>

    <!-- åˆ†æç»“æœå±•ç¤ºåŒº -->
    <div class="result-section" id="resultSection">
        <!-- å¯¼å‡ºæŒ‰é’®ç»„ -->
        <div class="btn-group">
            <button id="exportPdfBtn" class="bg-green-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-green-700 transition-colors">
                ğŸ“„ å¯¼å‡ºPDFæŠ¥å‘Š
            </button>
            <button id="exportExcelBtn" class="bg-orange-600 text-white py-2 px-4 rounded-lg font-medium hover:bg-orange-700 transition-colors">
                ğŸ“Š å¯¼å‡ºExcelæ•°æ®
            </button>
        </div>

        <!-- åˆ†ææ¦‚è¦ -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">åˆ†ææ¦‚è¦</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">è‚¡ç¥¨ä»£ç </p>
                    <p class="text-lg font-medium" id="summaryTicker"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">è‚¡ç¥¨åç§°</p>
                    <p class="text-lg font-medium" id="summaryStockName"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">ç›®æ ‡æ¶¨è·Œå¹…</p>
                    <p class="text-lg font-medium" id="summaryChange"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">ä¿¡å·ç‚¹æ•°é‡</p>
                    <p class="text-lg font-medium" id="summarySignalCount"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">åˆ†ææ—¶é—´èŒƒå›´</p>
                    <p class="text-lg font-medium" id="summaryDateRange"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">æŠ¥å‘Šç”Ÿæˆæ—¶é—´</p>
                    <p class="text-lg font-medium" id="summaryGeneratedAt"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">å¸‚åœºåŒºåŸŸ</p>
                    <p class="text-lg font-medium" id="summaryRegion"></p>
                </div>
                <div class="bg-gray-50 p-4 rounded-lg">
                    <p class="text-sm text-gray-500">äº¤æ˜“è´§å¸</p>
                    <p class="text-lg font-medium" id="summaryCurrency"></p>
                </div>
            </div>
        </div>

        <!-- ä»·æ ¼èµ°åŠ¿ + ä¿¡å·ç‚¹ -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">ä»·æ ¼èµ°åŠ¿ä¸ä¿¡å·ç‚¹</h2>
            <div class="chart-container">
                <!-- å›¾è¡¨åŠ è½½åŠ¨ç”» -->
                <div class="chart-loading" id="priceChartLoading">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-2"></div>
                    <p>å›¾è¡¨åŠ è½½ä¸­...</p>
                </div>
                <img id="priceChart" class="w-full h-auto rounded-lg" onload="hideChartLoading('priceChartLoading')" />
            </div>
        </div>

        <!-- ç®±çº¿å›¾ -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">ä¸åŒå‘¨æœŸæ”¶ç›Šç‡åˆ†å¸ƒï¼ˆç®±çº¿å›¾ï¼‰</h2>
            <div class="chart-container">
                <div class="chart-loading" id="boxplotChartLoading">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-2"></div>
                    <p>å›¾è¡¨åŠ è½½ä¸­...</p>
                </div>
                <img id="boxplotChart" class="w-full h-auto rounded-lg" onload="hideChartLoading('boxplotChartLoading')" />
            </div>
        </div>

        <!-- æ”¶ç›Šç‡åˆ†å¸ƒç›´æ–¹å›¾ -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">æ”¶ç›Šç‡åˆ†å¸ƒç›´æ–¹å›¾</h2>
            <div class="chart-container">
                <div class="chart-loading" id="distributionChartLoading">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-2"></div>
                    <p>å›¾è¡¨åŠ è½½ä¸­...</p>
                </div>
                <img id="distributionChart" class="w-full h-auto rounded-lg" onload="hideChartLoading('distributionChartLoading')" />
            </div>
        </div>

        <!-- ç´¯è®¡æ”¶ç›Šç‡ -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">å¹³å‡ç´¯è®¡æ”¶ç›Šç‡</h2>
            <div class="chart-container">
                <div class="chart-loading" id="cumulativeChartLoading">
                    <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-2"></div>
                    <p>å›¾è¡¨åŠ è½½ä¸­...</p>
                </div>
                <img id="cumulativeChart" class="w-full h-auto rounded-lg" onload="hideChartLoading('cumulativeChartLoading')" />
            </div>
        </div>

        <!-- ç»Ÿè®¡è¡¨æ ¼ -->
        <div class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">ç»Ÿè®¡åˆ†æç»“æœ</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="statsTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‘¨æœŸ</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ ·æœ¬æ•°</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å‡å€¼(%)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ä¸­ä½æ•°(%)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ ‡å‡†å·®(%)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€å°å€¼(%)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æœ€å¤§å€¼(%)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">æ­£æ”¶ç›Šæ¯”ä¾‹(%)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ååº¦</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">å³°åº¦</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="statsTableBody">
                        <!-- åŠ¨æ€æ’å…¥æ•°æ® -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…³é”®é…ç½®ï¼ˆå¿…é¡»ä¿®æ”¹ï¼ï¼‰====================
        const GITHUB_USERNAME = "aaroncheungzy";  // æ›¿æ¢ä¸ºä½ çš„GitHubç”¨æˆ·åï¼ˆå¦‚ï¼šoctocatï¼‰
        const REPO_NAME = "stock-analysis-tool";    // æ›¿æ¢ä¸ºä½ çš„ä»“åº“åï¼ˆå¦‚ï¼šstock-analysis-toolï¼‰
        // =============================================================

        // GitHub Functions API åœ°å€ï¼ˆè‡ªåŠ¨æ‹¼æ¥ï¼‰
        const API_BASE_URL = `https://${GITHUB_USERNAME}.github.io/${REPO_NAME}/api`;
        const ANALYZE_API = `${API_BASE_URL}/analyze`;
        const SEARCH_API = `${API_BASE_URL}/search-stocks`;

        let currentResult = null; // å­˜å‚¨å½“å‰åˆ†æç»“æœï¼ˆç”¨äºå¯¼å‡ºï¼‰

        // DOM å…ƒç´ 
        const form = document.getElementById('analysisForm');
        const tickerInput = document.getElementById('ticker');
        const searchResults = document.getElementById('searchResults');
        const loading = document.getElementById('loading');
        const resultSection = document.getElementById('resultSection');
        const errorAlert = document.getElementById('errorAlert');
        const exportPdfBtn = document.getElementById('exportPdfBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');

        // 1. è‚¡ç¥¨æœç´¢åŠŸèƒ½
        tickerInput.addEventListener('input', async (e) => {
            const keyword = e.target.value.trim();
            if (keyword.length < 1) {
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
                return;
            }

            try {
                // è°ƒç”¨ GitHub Functions æœç´¢æ¥å£
                const response = await fetch(`${SEARCH_API}?keyword=${encodeURIComponent(keyword)}`);
                const data = await response.json();
                
                if (!data.success) {
                    searchResults.innerHTML = `<div class="search-result-item text-red-500">${data.message || 'æœç´¢å¤±è´¥'}</div>`;
                    searchResults.style.display = 'block';
                    return;
                }

                if (data.data.length === 0) {
                    searchResults.innerHTML = '<div class="search-result-item text-gray-500">æœªæ‰¾åˆ°åŒ¹é…è‚¡ç¥¨</div>';
                    searchResults.style.display = 'block';
                    return;
                }

                // æ¸²æŸ“æœç´¢ç»“æœ
                let html = '';
                data.data.forEach(stock => {
                    html += `
                        <div class="search-result-item border-b border-gray-100" data-symbol="${stock.symbol}">
                            <div class="font-medium">${stock.symbol} - ${stock.name}</div>
                            <div class="text-sm text-gray-500">${stock.region} Â· ${stock.currency} Â· ${stock.type}</div>
                        </div>
                    `;
                });
                searchResults.innerHTML = html;
                searchResults.style.display = 'block';
            } catch (error) {
                console.error('æœç´¢å¤±è´¥ï¼š', error);
                searchResults.innerHTML = '<div class="search-result-item text-red-500">æœç´¢æœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•</div>';
                searchResults.style.display = 'block';
            }
        });

        // é€‰æ‹©æœç´¢ç»“æœ
        searchResults.addEventListener('click', (e) => {
            const item = e.target.closest('.search-result-item');
            if (item && item.dataset.symbol) {
                tickerInput.value = item.dataset.symbol;
                searchResults.innerHTML = '';
                searchResults.style.display = 'none';
            }
        });

        // ç‚¹å‡»é¡µé¢å…¶ä»–åŒºåŸŸå…³é—­æœç´¢ç»“æœ
        document.addEventListener('click', (e) => {
            if (!tickerInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // 2. è¡¨å•æäº¤å¤„ç†
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const params = {
                ticker: formData.get('ticker').trim(),
                target_change: parseFloat(formData.get('targetChange')),
                period: formData.get('period')
            };

            // è¡¨å•éªŒè¯
            if (isNaN(params.target_change)) {
                errorAlert.textContent = 'âŒ ç›®æ ‡æ¶¨è·Œå¹…å¿…é¡»æ˜¯æ•°å­—';
                errorAlert.style.display = 'block';
                return;
            }

            // æ˜¾ç¤ºåŠ è½½ä¸­ï¼Œéšè—é”™è¯¯å’Œç»“æœ
            loading.style.display = 'block';
            errorAlert.style.display = 'none';
            resultSection.style.display = 'none';

            try {
                // è°ƒç”¨ GitHub Functions åˆ†ææ¥å£
                const response = await fetch(ANALYZE_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(params),
                    timeout: 20000 // å»¶é•¿è¶…æ—¶æ—¶é—´ï¼ˆé€‚é…å‡½æ•°å†·å¯åŠ¨ï¼‰
                });

                if (!response.ok) {
                    throw new Error(`æ¥å£è¯·æ±‚å¤±è´¥ï¼ˆçŠ¶æ€ç ï¼š${response.status}ï¼‰`);
                }

                const data = await response.json();
                if (!data.success) {
                    throw new Error(data.message || 'åˆ†æå¤±è´¥');
                }

                // å­˜å‚¨å½“å‰ç»“æœï¼ˆç”¨äºå¯¼å‡ºï¼‰
                currentResult = data.data;
                // æ¸²æŸ“ç»“æœ
                renderResult(data.data);
            } catch (error) {
                // æ˜¾ç¤ºé”™è¯¯
                errorAlert.textContent = `âŒ ${error.message}`;
                errorAlert.style.display = 'block';
            } finally {
                // éšè—åŠ è½½ä¸­
                loading.style.display = 'none';
            }
        });

        // 3. æ¸²æŸ“åˆ†æç»“æœ
        function renderResult(result) {
            // å¡«å……æ¦‚è¦ä¿¡æ¯
            document.getElementById('summaryTicker').textContent = result.ticker;
            document.getElementById('summaryStockName').textContent = result.ticker_info.shortName || 'æœªçŸ¥åç§°';
            document.getElementById('summaryChange').textContent = `${result.target_change}%`;
            document.getElementById('summarySignalCount').textContent = `${result.signal_count} ä¸ª`;
            document.getElementById('summaryDateRange').textContent = `${result.date_range.start} è‡³ ${result.date_range.end}`;
            document.getElementById('summaryGeneratedAt').textContent = result.generated_at;
            document.getElementById('summaryRegion').textContent = result.ticker_info.region || 'æœªçŸ¥';
            document.getElementById('summaryCurrency').textContent = result.ticker_info.currency || 'æœªçŸ¥';

            // é‡ç½®å›¾è¡¨åŠ è½½åŠ¨ç”»
            document.querySelectorAll('.chart-loading').forEach(el => el.style.display = 'flex');
            // å¡«å……å›¾è¡¨ï¼ˆå…¼å®¹ç©ºå›¾è¡¨æƒ…å†µï¼‰
            document.getElementById('priceChart').src = result.charts.price_with_signals || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
            document.getElementById('boxplotChart').src = result.charts.boxplot_comparison || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
            document.getElementById('distributionChart').src = result.charts.returns_distribution || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';
            document.getElementById('cumulativeChart').src = result.charts.cumulative_returns || 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==';

            // å¡«å……ç»Ÿè®¡è¡¨æ ¼
            const tableBody = document.getElementById('statsTableBody');
            tableBody.innerHTML = '';
            const sortedPeriods = Object.keys(result.stats).sort((a, b) => a - b);
            
            if (sortedPeriods.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `<td colspan="10" class="px-6 py-4 text-center text-gray-500">æš‚æ— ç»Ÿè®¡æ•°æ®</td>`;
                tableBody.appendChild(emptyRow);
                return;
            }

            sortedPeriods.forEach(period => {
                const stats = result.stats[period];
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${period}æ—¥</td>
                    <td class="px-6 py-4 whitespace-nowrap">${stats.count}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${stats.mean}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${stats.median}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${stats.std}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${stats.min}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${stats.max}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${stats.positive_rate}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${stats.skewness}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${stats.kurtosis}</td>
                `;
                tableBody.appendChild(row);
            });

            // æ˜¾ç¤ºç»“æœåŒºåŸŸ
            resultSection.style.display = 'block';
        }

        // 4. å›¾è¡¨åŠ è½½å®Œæˆåéšè—åŠ è½½åŠ¨ç”»
        function hideChartLoading(loadingId) {
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) {
                setTimeout(() => {
                    loadingEl.style.display = 'none';
                }, 300); // å»¶è¿Ÿéšè—ï¼Œé¿å…é—ªçƒ
            }
        }

        // 5. å¯¼å‡ºPDFæŠ¥å‘Š
        exportPdfBtn.addEventListener('click', async () => {
            if (!currentResult) return alert('æš‚æ— åˆ†æç»“æœå¯å¯¼å‡º');

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('l', 'mm', 'a4'); // æ¨ªå‘A4çº¸
                pdf.setProperties({
                    title: `${currentResult.ticker}_æ¶¨è·Œå¹…${currentResult.target_change}%_åˆ†ææŠ¥å‘Š`,
                    subject: 'è‚¡ç¥¨æ¶¨è·Œå¹…åˆ†æ',
                    author: 'è‚¡ç¥¨åˆ†æå·¥å…·ï¼ˆå…¨GitHubéƒ¨ç½²ï¼‰'
                });

                // æ·»åŠ æ ‡é¢˜
                pdf.setFontSize(18);
                pdf.text(`è‚¡ç¥¨æ¶¨è·Œå¹…åˆ†ææŠ¥å‘Š - ${currentResult.ticker}`, 10, 20);

                // æ·»åŠ æ¦‚è¦ä¿¡æ¯
                pdf.setFontSize(12);
                pdf.text('ä¸€ã€åˆ†ææ¦‚è¦', 10, 40);
                const summaryText = [
                    `è‚¡ç¥¨ä»£ç ï¼š${currentResult.ticker}`,
                    `è‚¡ç¥¨åç§°ï¼š${currentResult.ticker_info.shortName || 'æœªçŸ¥åç§°'}`,
                    `ç›®æ ‡æ¶¨è·Œå¹…ï¼š${currentResult.target_change}%`,
                    `ä¿¡å·ç‚¹æ•°é‡ï¼š${currentResult.signal_count} ä¸ª`,
                    `åˆ†ææ—¶é—´èŒƒå›´ï¼š${currentResult.date_range.start} è‡³ ${currentResult.date_range.end}`,
                    `æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š${currentResult.generated_at}`,
                    `å¸‚åœºåŒºåŸŸï¼š${currentResult.ticker_info.region || 'æœªçŸ¥'}`,
                    `äº¤æ˜“è´§å¸ï¼š${currentResult.ticker_info.currency || 'æœªçŸ¥'}`
                ];
                summaryText.forEach((text, index) => {
                    pdf.text(text, 20, 55 + index * 8);
                });

                // æ·»åŠ ç»Ÿè®¡è¡¨æ ¼ï¼ˆè½¬æ¢ä¸ºå›¾ç‰‡ï¼‰
                pdf.text('äºŒã€ç»Ÿè®¡åˆ†æç»“æœ', 10, 110);
                const table = document.getElementById('statsTable');
                await html2canvas(table, { 
                    scale: 2, 
                    useCORS: true,
                    logging: false
                }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    pdf.addImage(imgData, 'PNG', 10, 120, 270, 80); // é€‚åº”A4å®½åº¦
                });

                // æ·»åŠ ä»·æ ¼èµ°åŠ¿å›¾è¡¨
                pdf.addPage();
                pdf.text('ä¸‰ã€ä»·æ ¼èµ°åŠ¿ä¸ä¿¡å·ç‚¹', 10, 20);
                const priceImg = document.getElementById('priceChart');
                pdf.addImage(priceImg.src, 'PNG', 10, 30, 270, 120);

                // æ·»åŠ ç®±çº¿å›¾
                pdf.addPage();
                pdf.text('å››ã€ä¸åŒå‘¨æœŸæ”¶ç›Šç‡åˆ†å¸ƒï¼ˆç®±çº¿å›¾ï¼‰', 10, 20);
                const boxplotImg = document.getElementById('boxplotChart');
                pdf.addImage(boxplotImg.src, 'PNG', 10, 30, 270, 120);

                // æ·»åŠ ç›´æ–¹å›¾
                pdf.addPage();
                pdf.text('äº”ã€æ”¶ç›Šç‡åˆ†å¸ƒç›´æ–¹å›¾', 10, 20);
                const distImg = document.getElementById('distributionChart');
                pdf.addImage(distImg.src, 'PNG', 10, 30, 270, 120);

                // æ·»åŠ ç´¯è®¡æ”¶ç›Šç‡å›¾
                pdf.addPage();
                pdf.text('å…­ã€å¹³å‡ç´¯è®¡æ”¶ç›Šç‡', 10, 20);
                const cumImg = document.getElementById('cumulativeChart');
                pdf.addImage(cumImg.src, 'PNG', 10, 30, 270, 120);

                // ä¿å­˜PDF
                pdf.save(`${currentResult.ticker}_æ¶¨è·Œå¹…${currentResult.target_change}%_åˆ†ææŠ¥å‘Š.pdf`);
            } catch (error) {
                console.error('PDFå¯¼å‡ºå¤±è´¥ï¼š', error);
                alert('PDFå¯¼å‡ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        });

        // 6. å¯¼å‡ºExcelæ•°æ®
        exportExcelBtn.addEventListener('click', () => {
            if (!currentResult) return alert('æš‚æ— åˆ†æç»“æœå¯å¯¼å‡º');

            try {
                // åˆ›å»ºå·¥ä½œç°¿
                const wb = XLSX.utils.book_new();
                wb.Props = {
                    Title: `${currentResult.ticker} æ¶¨è·Œå¹…åˆ†ææ•°æ®`,
                    Subject: 'è‚¡ç¥¨åˆ†æ',
                    Author: 'è‚¡ç¥¨åˆ†æå·¥å…·',
                    CreatedDate: new Date()
                };

                // 1. æ¦‚è¦ä¿¡æ¯å·¥ä½œè¡¨
                const summaryData = [
                    ['é¡¹ç›®', 'å€¼'],
                    ['è‚¡ç¥¨ä»£ç ', currentResult.ticker],
                    ['è‚¡ç¥¨åç§°', currentResult.ticker_info.shortName || 'æœªçŸ¥åç§°'],
                    ['ç›®æ ‡æ¶¨è·Œå¹…(%)', currentResult.target_change],
                    ['ä¿¡å·ç‚¹æ•°é‡', currentResult.signal_count],
                    ['åˆ†æå¼€å§‹æ—¥æœŸ', currentResult.date_range.start],
                    ['åˆ†æç»“æŸæ—¥æœŸ', currentResult.date_range.end],
                    ['æŠ¥å‘Šç”Ÿæˆæ—¶é—´', currentResult.generated_at],
                    ['å¸‚åœºåŒºåŸŸ', currentResult.ticker_info.region || 'æœªçŸ¥'],
                    ['äº¤æ˜“è´§å¸', currentResult.ticker_info.currency || 'æœªçŸ¥']
                ];
                const summaryWs = XLSX.utils.aoa_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(wb, summaryWs, 'åˆ†ææ¦‚è¦');

                // 2. ç»Ÿè®¡ç»“æœå·¥ä½œè¡¨
                const statsHeaders = ['å‘¨æœŸ(æ—¥)', 'æ ·æœ¬æ•°', 'å‡å€¼(%)', 'ä¸­ä½æ•°(%)', 'æ ‡å‡†å·®(%)', 'æœ€å°å€¼(%)', 'æœ€å¤§å€¼(%)', 'æ­£æ”¶ç›Šæ¯”ä¾‹(%)', 'ååº¦', 'å³°åº¦'];
                const statsData = [statsHeaders];
                const sortedPeriods = Object.keys(currentResult.stats).sort((a, b) => a - b);
                sortedPeriods.forEach(period => {
                    const stats = currentResult.stats[period];
                    statsData.push([
                        period,
                        stats.count,
                        stats.mean,
                        stats.median,
                        stats.std,
                        stats.min,
                        stats.max,
                        stats.positive_rate,
                        stats.skewness,
                        stats.kurtosis
                    ]);
                });
                const statsWs = XLSX.utils.aoa_to_sheet(statsData);
                XLSX.utils.book_append_sheet(wb, statsWs, 'ç»Ÿè®¡ç»“æœ');

                // 3. åŸå§‹æ”¶ç›Šç‡æ•°æ®å·¥ä½œè¡¨
                const returnsData = [['å‘¨æœŸ(æ—¥)', 'æ”¶ç›Šç‡(%)']];
                sortedPeriods.forEach(period => {
                    const returns = currentResult.future_returns[period];
                    returns.forEach(ret => {
                        returnsData.push([period, ret.toFixed(2)]);
                    });
                });
                const returnsWs = XLSX.utils.aoa_to_sheet(returnsData);
                XLSX.utils.book_append_sheet(wb, returnsWs, 'åŸå§‹æ”¶ç›Šç‡æ•°æ®');

                // ä¿å­˜Excelæ–‡ä»¶
                XLSX.writeFile(wb, `${currentResult.ticker}_æ¶¨è·Œå¹…${currentResult.target_change}%_åˆ†ææ•°æ®.xlsx`);
            } catch (error) {
                console.error('Excelå¯¼å‡ºå¤±è´¥ï¼š', error);
                alert('Excelå¯¼å‡ºå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        });

        // 7. é€‚é…ç§»åŠ¨ç«¯æ ·å¼
        window.addEventListener('resize', () => {
            const chartContainers = document.querySelectorAll('.chart-container');
            if (window.innerWidth < 768) {
                chartContainers.forEach(container => {
                    container.style.height = '300px';
                });
            } else {
                chartContainers.forEach(container => {
                    container.style.height = '400px';
                });
            }
        });
    </script>
</body>
</html>
